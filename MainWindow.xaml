<Window x:Class="SamsGameLauncher.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:models="clr-namespace:SamsGameLauncher.Models"
        xmlns:scm="clr-namespace:System.ComponentModel;assembly=WindowsBase"
        Title="Sam's Game Launcher" Height="600" Width="800" WindowState="Maximized"
        Icon="Assets/launcher.ico" Background="#1e1e1e">

    <!-- Resources Section -->
    <Window.Resources>
        <!-- CollectionViewSource for grouping games -->
        <CollectionViewSource x:Key="GroupedGames" Source="{Binding Games}">
            <CollectionViewSource.GroupDescriptions>
                <PropertyGroupDescription PropertyName="Console"/>
            </CollectionViewSource.GroupDescriptions>
            <CollectionViewSource.SortDescriptions>
                <scm:SortDescription PropertyName="Console" Direction="Ascending"/>
                <scm:SortDescription PropertyName="Name" Direction="Ascending"/>
            </CollectionViewSource.SortDescriptions>
        </CollectionViewSource>

        <!-- Implicit style for all MenuItems in this Menu -->
        <Style TargetType="MenuItem">
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Background" Value="#353535"/>
            <Setter Property="Padding" Value="6,2"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="MenuItem">
                        <Grid>
                            <Border Name="Border" Background="{TemplateBinding Background}">
                                <ContentPresenter ContentSource="Header" RecognizesAccessKey="True"
                                                  Margin="{TemplateBinding Padding}"/>
                            </Border>
                            <Popup Name="Popup" Placement="Bottom" IsOpen="{TemplateBinding IsSubmenuOpen}"
                                   AllowsTransparency="True" Focusable="False" PopupAnimation="Fade">
                                <Border Background="#FF2A2A2A" BorderBrush="#FF444444" BorderThickness="1">
                                    <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Cycle"/>
                                </Border>
                            </Popup>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#6A6A6A"/>
                            </Trigger>
                            <Trigger Property="IsSubmenuOpen" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#6A6A6A"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DarkContextMenuStyle" TargetType="{x:Type ContextMenu}">
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="Background" Value="#FF2A2A2A"/>
            <Setter Property="BorderBrush" Value="#FF444444"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="HasDropShadow" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ContextMenu}">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Cycle"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <DockPanel>
        <!-- Toolbar/Menu at the top -->
        <Menu DockPanel.Dock="Top" Background="#353535" Foreground="White">
            <MenuItem Header="System">
                <MenuItem Header="Add Emulator..." Click="AddEmulator_Click"/>
                <MenuItem Header="Add Game..." Click="AddGame_Click"/>
            </MenuItem>
            <MenuItem Header="Settings"/>
            <MenuItem Header="Help"/>
        </Menu>

        <!-- Search Bar Section -->
        <Grid DockPanel.Dock="Top" Background="#1e1e1e" Margin="0,10,0,0" HorizontalAlignment="Center">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center" Margin="5">
                <TextBox x:Name="SearchTextBox" Width="200" Height="20" Text="Search..."
                         Foreground="#b2b2b2" GotFocus="SearchTextBox_GotFocus"
                         LostFocus="SearchTextBox_LostFocus" TextChanged="SearchTextBox_TextChanged"/>
            </StackPanel>
            <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="5">
                <TextBlock Text="Group By:" Foreground="White" VerticalAlignment="Center" Margin="0,0,5,0"/>
                <ComboBox x:Name="GroupByComboBox" Width="120" Height="20" SelectedIndex="0"
                          SelectionChanged="GroupByComboBox_SelectionChanged">
                    <ComboBoxItem Content="Console"/>
                    <ComboBoxItem Content="Genre"/>
                    <ComboBoxItem Content="Year"/>
                </ComboBox>
            </StackPanel>
        </Grid>

        <!-- Main Content: Grouped Game List -->
        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <!-- Notice that we now bind to the new base type (GameBase) -->
            <ItemsControl x:Name="GameItemsControl" ItemsSource="{Binding Source={StaticResource GroupedGames}}">
                <!-- Group style -->
                <ItemsControl.GroupStyle>
                    <GroupStyle>
                        <GroupStyle.HeaderTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Name}" FontWeight="Bold" FontSize="16"
                                           Foreground="White" Margin="10,20,10,10"/>
                            </DataTemplate>
                        </GroupStyle.HeaderTemplate>
                        <GroupStyle.Panel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Vertical"/>
                            </ItemsPanelTemplate>
                        </GroupStyle.Panel>
                    </GroupStyle>
                </ItemsControl.GroupStyle>

                <!-- Global fallback ItemsPanel -->
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <!-- DataTemplate for each game tile -->
                <!-- Updated DataType to models:GameBase and binding to GameCoverUri instead of ImageUri -->
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type models:GameBase}">
                        <StackPanel Margin="10" Width="150" MouseLeftButtonUp="GameCard_Click" Cursor="Hand">
                            <Border x:Name="ImageBorder" Width="150" Height="200" Background="Black">
                                <Image x:Name="GameImage" Source="{Binding GameCoverUri}" Stretch="UniformToFill"/>
                            </Border>
                            <TextBlock Text="{Binding Name}" Foreground="White" FontSize="12" Margin="5,5,5,0"
                                       HorizontalAlignment="Center" TextWrapping="Wrap" TextAlignment="Center"/>
                            <!-- Context menu for right-click options -->
                            <StackPanel.ContextMenu>
                                <ContextMenu Style="{StaticResource DarkContextMenuStyle}">
                                    <MenuItem Header="Run" Click="RunMenuItem_Click"/>
                                    <MenuItem Header="Edit" Click="EditMenuItem_Click"/>
                                    <MenuItem Header="Delete" Click="DeleteMenuItem_Click"/>
                                </ContextMenu>
                            </StackPanel.ContextMenu>
                        </StackPanel>
                        <DataTemplate.Triggers>
                            <DataTrigger Binding="{Binding Console}" Value="PlayStation 1">
                                <Setter TargetName="ImageBorder" Property="Width" Value="150"/>
                                <Setter TargetName="ImageBorder" Property="Height" Value="150"/>
                                <Setter TargetName="ImageBorder" Property="HorizontalAlignment" Value="Center"/>
                                <Setter TargetName="ImageBorder" Property="VerticalAlignment" Value="Center"/>
                                <Setter TargetName="GameImage" Property="Stretch" Value="UniformToFill"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Console}" Value="PlayStation 2">
                                <Setter TargetName="ImageBorder" Property="Width" Value="150"/>
                                <Setter TargetName="ImageBorder" Property="Height" Value="200"/>
                                <Setter TargetName="GameImage" Property="Stretch" Value="Fill"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Console}" Value="PlayStation 3">
                                <Setter TargetName="ImageBorder" Property="Width" Value="150"/>
                                <Setter TargetName="ImageBorder" Property="Height" Value="180"/>
                                <Setter TargetName="GameImage" Property="Stretch" Value="Fill"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Console}" Value="Game Boy Advance">
                                <Setter TargetName="ImageBorder" Property="Width" Value="150"/>
                                <Setter TargetName="ImageBorder" Property="Height" Value="150"/>
                                <Setter TargetName="ImageBorder" Property="HorizontalAlignment" Value="Center"/>
                                <Setter TargetName="ImageBorder" Property="VerticalAlignment" Value="Center"/>
                                <Setter TargetName="GameImage" Property="Stretch" Value="UniformToFill"/>
                            </DataTrigger>
                        </DataTemplate.Triggers>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
    </DockPanel>
</Window>
